<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RevisionManagement.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">r43ples</a> &gt; <a href="index.source.html" class="el_package">de.tud.plt.r43ples.core</a> &gt; <span class="el_source">RevisionManagement.java</span></div><h1>RevisionManagement.java</h1><pre class="source lang-java linenums">package de.tud.plt.r43ples.core;

import com.hp.hpl.jena.query.QuerySolution;
import com.hp.hpl.jena.query.ResultSet;
import de.tud.plt.r43ples.exception.InternalErrorException;
import de.tud.plt.r43ples.existentobjects.RevisionGraph;
import de.tud.plt.r43ples.management.Config;
import de.tud.plt.r43ples.triplestoreInterface.TripleStoreInterface;
import de.tud.plt.r43ples.triplestoreInterface.TripleStoreInterfaceSingleton;
import org.apache.log4j.Logger;

import java.util.ArrayList;

/**
 * Provides access to the basic revision graph which stores all references to sub revision graphs.
 *
 * @author Stephan Hensel
 */
public class RevisionManagement {

    /**
     * The logger.
     **/
<span class="fc" id="L24">    private Logger logger = Logger.getLogger(RevisionManagement.class);</span>

    // Dependencies
    /**
     * The triplestore interface to use.
     **/
    private TripleStoreInterface tripleStoreInterface;


    /**
     * The constructor.
     */
<span class="fc" id="L36">    protected RevisionManagement() {</span>
        // Dependencies
<span class="fc" id="L38">        this.tripleStoreInterface = TripleStoreInterfaceSingleton.get();</span>

<span class="fc" id="L40">    }</span>

    /**
     * Get all named graphs URIs by querying the main revision graph.
     *
     * @return the list of named graphs URIs
     */
    private ArrayList&lt;String&gt; getAllNamedGraphsURIs() {
<span class="fc" id="L48">        this.logger.debug(&quot;Get all named graph URIs.&quot;);</span>

<span class="fc" id="L50">        ArrayList&lt;String&gt; uriList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L52">        String query = Config.prefixes + String.format(&quot;&quot;</span>
                + &quot;SELECT DISTINCT ?uri\n&quot;
                + &quot;WHERE {\n&quot;
                + &quot;  GRAPH &lt;%s&gt; {\n&quot;
                + &quot;    ?graph a rmo:Graph;\n&quot;
                + &quot;      rmo:hasRevisionGraph ?uriGraph.\n&quot;
                + &quot;  }\n&quot;
                + &quot;  GRAPH ?uriGraph {\n&quot;
                + &quot;    { bind( ?uriGraph as ?uri) }\n&quot;
                + &quot;    UNION\n&quot;
                + &quot;    { ?ref rmo:fullGraph ?uri. }\n&quot;
                + &quot;    UNION\n&quot;
                + &quot;    { ?rev rmo:addSet ?uri. }\n&quot;
                + &quot;    UNION\n&quot;
                + &quot;    { ?rev rmo:deleteSet ?uri }\n&quot;
                + &quot;  }\n&quot;
                + &quot;}\n&quot;, Config.revision_graph);
<span class="fc" id="L69">        this.logger.debug(query);</span>
<span class="fc" id="L70">        ResultSet resultSet = tripleStoreInterface.executeSelectQuery(query);</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">        while (resultSet.hasNext()) {</span>
<span class="fc" id="L72">            QuerySolution qs = resultSet.next();</span>
<span class="fc" id="L73">            uriList.add(qs.getResource(&quot;?uri&quot;).toString());</span>
<span class="fc" id="L74">        }</span>

<span class="fc" id="L76">        return uriList;</span>
    }

    /**
     * Checks if a named graph URI is already used by R43ples.
     *
     * @param namedGraphURI the named graph URI to check
     * @return true if the named graph URI is already in use
     */
    protected boolean checkNamedGraphExistence(String namedGraphURI) {
<span class="fc" id="L86">        return getAllNamedGraphsURIs().contains(namedGraphURI);</span>
    }

    /**
     * Get a new revision graph URI.
     *
     * @param revisionGraphName  the revision graph name
     * @return the new revision graph URI
     * @throws InternalErrorException
     */
    protected String getNewRevisionGraphURI(String revisionGraphName) throws InternalErrorException {
<span class="fc" id="L97">        String revisionGraphURI = revisionGraphName + &quot;-revisiongraph&quot;;</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        if (!checkNamedGraphExistence(revisionGraphURI)) {</span>
<span class="fc" id="L99">            return revisionGraphURI;</span>
        } else {
<span class="fc" id="L101">            throw new InternalErrorException(&quot;The calculated revision graph URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new revision URI.
     *
     * @param revisionGraph      the corresponding revision graph
     * @param revisionIdentifier the revision identifier of the corresponding revision
     * @return the new revision URI
     * @throws InternalErrorException
     */
    protected String getNewRevisionURI(RevisionGraph revisionGraph, String revisionIdentifier) throws InternalErrorException {
<span class="fc" id="L114">        String revisionURI = revisionGraph.getGraphName() + &quot;-revision-&quot; + revisionIdentifier;</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(revisionURI)) {</span>
<span class="fc" id="L116">            return revisionURI;</span>
        } else {
<span class="nc" id="L118">            throw new InternalErrorException(&quot;The calculated revision URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new add set URI.
     *
     * @param revisionGraph      the corresponding revision graph
     * @param revisionIdentifier the revision identifier of the corresponding revision
     * @return the new add set URI
     * @throws InternalErrorException
     */
    protected String getNewAddSetURI(RevisionGraph revisionGraph, String revisionIdentifier) throws InternalErrorException {
<span class="fc" id="L131">        String addSetURI = revisionGraph.getGraphName() + &quot;-addSet-&quot; + revisionIdentifier;</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(addSetURI)) {</span>
<span class="fc" id="L133">            return addSetURI;</span>
        } else {
<span class="nc" id="L135">            throw new InternalErrorException(&quot;The calculated add set URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new delete set URI.
     *
     * @param revisionGraph      the corresponding revision graph
     * @param revisionIdentifier the revision identifier of the corresponding revision
     * @return the new delete set URI
     * @throws InternalErrorException
     */
    protected String getNewDeleteSetURI(RevisionGraph revisionGraph, String revisionIdentifier) throws InternalErrorException {
<span class="fc" id="L148">        String deleteSetURI = revisionGraph.getGraphName() + &quot;-deleteSet-&quot; + revisionIdentifier;</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(deleteSetURI)) {</span>
<span class="fc" id="L150">            return deleteSetURI;</span>
        } else {
<span class="nc" id="L152">            throw new InternalErrorException(&quot;The calculated delete set URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new branch URI.
     *
     * @param revisionGraph    the corresponding revision graph
     * @param branchIdentifier the branch identifier of the corresponding revision
     * @return the new branch URI
     * @throws InternalErrorException
     */
    protected String getNewBranchURI(RevisionGraph revisionGraph, String branchIdentifier) throws InternalErrorException {
<span class="fc" id="L165">        String branchURI = revisionGraph.getGraphName() + &quot;-branch-&quot; + branchIdentifier;</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(branchURI)) {</span>
<span class="fc" id="L167">            return branchURI;</span>
        } else {
<span class="nc" id="L169">            throw new InternalErrorException(&quot;The calculated branch URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new master URI.
     *
     * @param revisionGraph    the corresponding revision graph
     * @return the new master URI
     * @throws InternalErrorException
     */
    protected String getNewMasterURI(RevisionGraph revisionGraph) throws InternalErrorException {
<span class="fc" id="L181">        String masterURI = revisionGraph.getGraphName() + &quot;-master&quot;;</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(masterURI)) {</span>
<span class="fc" id="L183">            return masterURI;</span>
        } else {
<span class="nc" id="L185">            throw new InternalErrorException(&quot;The calculated master URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new tag URI.
     *
     * @param revisionGraph the corresponding revision graph
     * @param tagIdentifier the tag identifier of the corresponding revision
     * @return the new tag URI
     * @throws InternalErrorException
     */
    protected String getNewTagURI(RevisionGraph revisionGraph, String tagIdentifier) throws InternalErrorException {
<span class="fc" id="L198">        String tagURI = revisionGraph.getGraphName() + &quot;-tag-&quot; + tagIdentifier;</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(tagURI)) {</span>
<span class="fc" id="L200">            return tagURI;</span>
        } else {
<span class="nc" id="L202">            throw new InternalErrorException(&quot;The calculated tag URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new commit URI.
     *
     * @param revisionGraph      the corresponding revision graph
     * @param revisionIdentifier the revision identifier of the created revision
     * @return the new commit URI
     * @throws InternalErrorException
     */
    protected String getNewCommitURI(RevisionGraph revisionGraph, String revisionIdentifier) throws InternalErrorException {
<span class="fc" id="L215">        String commitURI = revisionGraph.getGraphName() + &quot;-commit-&quot; + revisionIdentifier;</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(commitURI)) {</span>
<span class="fc" id="L217">            return commitURI;</span>
        } else {
<span class="nc" id="L219">            throw new InternalErrorException(&quot;The calculated commit URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new three way merge commit URI.
     *
     * @param revisionGraph      the corresponding revision graph
     * @param revisionIdentifier the revision identifier of the created revision
     * @return the new commit URI
     * @throws InternalErrorException
     */
    protected String getNewThreeWayMergeCommitURI(RevisionGraph revisionGraph, String revisionIdentifier) throws InternalErrorException {
<span class="fc" id="L232">        String commitURI = revisionGraph.getGraphName() + &quot;-commit-merge-&quot; + revisionIdentifier;</span>
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(commitURI)) {</span>
<span class="fc" id="L234">            return commitURI;</span>
        } else {
<span class="nc" id="L236">            throw new InternalErrorException(&quot;The calculated commit URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new fast forward merge commit URI.
     *
     * @param revisionGraph the corresponding revision graph
     * @param sourceRevisionIdentifier the source revision identifier
     * @param targetRevisionIdentifier the target revision identifier
     * @return the new commit URI
     * @throws InternalErrorException
     */
    protected String getNewFastForwardMergeCommitURI(RevisionGraph revisionGraph, String sourceRevisionIdentifier, String targetRevisionIdentifier) throws InternalErrorException {
<span class="fc" id="L250">        String commitURI = revisionGraph.getGraphName() + &quot;-commit-ff-merge-&quot; + sourceRevisionIdentifier + &quot;-&quot; + targetRevisionIdentifier;</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(commitURI)) {</span>
<span class="fc" id="L252">            return commitURI;</span>
        } else {
<span class="nc" id="L254">            throw new InternalErrorException(&quot;The calculated commit URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new rebase merge commit URI.
     *
     * @param revisionGraph the corresponding revision graph
     * @param startRevisionIdentifier the start revision identifier
     * @param endRevisionIdentifier the end revision identifier
     * @param targetBranchIdentifier the target branch identifier
     * @param targetRevisionIdentifier the target revision identifier
     * @return the new commit URI
     * @throws InternalErrorException
     */
    protected String getNewPickCommitURI(RevisionGraph revisionGraph, String startRevisionIdentifier, String endRevisionIdentifier, String targetBranchIdentifier, String targetRevisionIdentifier) throws InternalErrorException {
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">        if (endRevisionIdentifier == null) {</span>
<span class="fc" id="L271">            endRevisionIdentifier = &quot;&quot;;</span>
        }
<span class="fc" id="L273">        String commitURI = revisionGraph.getGraphName() + &quot;-commit-pick-&quot; + startRevisionIdentifier + &quot;-&quot; + endRevisionIdentifier + &quot;-&quot; + targetBranchIdentifier + &quot;-&quot; + targetRevisionIdentifier;</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(commitURI)) {</span>
<span class="fc" id="L275">            return commitURI;</span>
        } else {
<span class="nc" id="L277">            throw new InternalErrorException(&quot;The calculated commit URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new branch commit URI.
     *
     * @param revisionGraph      the corresponding revision graph
     * @param branchIdentifier the branch identifier of the created branch
     * @return the new branch commit URI
     * @throws InternalErrorException
     */
    protected String getNewBranchCommitURI(RevisionGraph revisionGraph, String branchIdentifier) throws InternalErrorException {
<span class="fc" id="L290">        String commitURI = revisionGraph.getGraphName() + &quot;-commit-branch-&quot; + branchIdentifier;</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(commitURI)) {</span>
<span class="fc" id="L292">            return commitURI;</span>
        } else {
<span class="nc" id="L294">            throw new InternalErrorException(&quot;The calculated branch commit URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new tag commit URI.
     *
     * @param revisionGraph    the corresponding revision graph
     * @param tagIdentifier the tag identifier of the created tag
     * @return the new tag commit URI
     * @throws InternalErrorException
     */
    protected String getNewTagCommitURI(RevisionGraph revisionGraph, String tagIdentifier) throws InternalErrorException {
<span class="fc" id="L307">        String commitURI = revisionGraph.getGraphName() + &quot;-commit-tag-&quot; + tagIdentifier;</span>
<span class="pc bpc" id="L308" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(commitURI)) {</span>
<span class="fc" id="L309">            return commitURI;</span>
        } else {
<span class="nc" id="L311">            throw new InternalErrorException(&quot;The calculated tag commit URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new temporary revision progress URI (from).
     *
     * @param revisionGraph    the corresponding revision graph
     * @return the new temporary revision progress URI (from)
     * @throws InternalErrorException
     */
    protected String getTemporaryRevisionProgressFromURI(RevisionGraph revisionGraph) throws InternalErrorException {
        // TODO Create one method which calculates a temporary random URI (Attention the methods which are using this URI will have to drop the named graph after the usage is finished!)
<span class="fc" id="L324">        String tempURI = revisionGraph.getGraphName() + &quot;-RM-REVISION-PROGRESS-FROM&quot;;</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(tempURI)) {</span>
<span class="fc" id="L326">            return tempURI;</span>
        } else {
<span class="nc" id="L328">            throw new InternalErrorException(&quot;The calculated temporary URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new temporary revision progress URI (into).
     *
     * @param revisionGraph    the corresponding revision graph
     * @return the new temporary revision progress URI (into)
     * @throws InternalErrorException
     */
    protected String getTemporaryRevisionProgressIntoURI(RevisionGraph revisionGraph) throws InternalErrorException {
        // TODO Create one method which calculates a temporary random URI (Attention the methods which are using this URI will have to drop the named graph after the usage is finished!)
<span class="fc" id="L341">        String tempURI = revisionGraph.getGraphName() + &quot;-RM-REVISION-PROGRESS-INTO&quot;;</span>
<span class="pc bpc" id="L342" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(tempURI)) {</span>
<span class="fc" id="L343">            return tempURI;</span>
        } else {
<span class="nc" id="L345">            throw new InternalErrorException(&quot;The calculated temporary URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new temporary difference model URI.
     *
     * @param revisionGraph    the corresponding revision graph
     * @return the new temporary difference model URI
     * @throws InternalErrorException
     */
    protected String getTemporaryDifferenceModelURI(RevisionGraph revisionGraph) throws InternalErrorException {
        // TODO Create one method which calculates a temporary random URI (Attention the methods which are using this URI will have to drop the named graph after the usage is finished!)
<span class="fc" id="L358">        String tempURI = revisionGraph.getGraphName() + &quot;-RM-DIFFERENCE-MODEL&quot;;</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(tempURI)) {</span>
<span class="fc" id="L360">            return tempURI;</span>
        } else {
<span class="nc" id="L362">            throw new InternalErrorException(&quot;The calculated temporary URI is already in use.&quot;);</span>
        }
    }

    /**
     * Get a new temporary merged URI.
     *
     * @param revisionGraph    the corresponding revision graph
     * @return the new temporary difference model URI
     * @throws InternalErrorException
     */
    protected String getTemporaryMergedURI(RevisionGraph revisionGraph) throws InternalErrorException {
        // TODO Create one method which calculates a temporary random URI (Attention the methods which are using this URI will have to drop the named graph after the usage is finished!)
<span class="fc" id="L375">        String tempURI = revisionGraph.getGraphName() + &quot;-RM-MERGED-TEMP&quot;;</span>
<span class="pc bpc" id="L376" title="1 of 2 branches missed.">        if (!checkNamedGraphExistence(tempURI)) {</span>
<span class="fc" id="L377">            return tempURI;</span>
        } else {
<span class="nc" id="L379">            throw new InternalErrorException(&quot;The calculated temporary URI is already in use.&quot;);</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>